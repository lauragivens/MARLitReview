---
title: "Author Countries"
author: "Laura Givens"
date: "2025-05-20"
output: html_document
---
```{r}
library(readxl)
library(readr)
library(stringr)
library(ggplot2)
library(ggridges)
library(tidyverse)
library(patchwork)
library(flextable)
```

# Methods   

## 1. Download MAR Literature Review - Spreadsheet (most recent: 31 July 2025)  

## 2. Read into R  
There is one line per paper; each line is made up of a list of all coauthor institutions 
```{r load}
spdsht <- read_xlsx("/Users/lauragivens/Downloads/MAR\ Literature\ Review\ -\ Spreadsheet.xlsx",sheet = "ReviewSummary",col_names = TRUE,skip=2)
```

## 3. Subset spreadsheet to only papers that were identified as relevant  
```{r subset}
rel.spdsht <- spdsht %>% filter(str_detect(`Relevant to the manuscript?`,"Yes"))
```

## 4. Extract author countries from given addresses and split into first/coauthors  
_4a. Name repair_  
We remove the spaces in any of the country names so they aren't split later  
```{r remspaces}
rel.spdsht$addresses <- str_replace_all(rel.spdsht$addresses, "USA|US|U.S.A.|United States|United States of America", " USA")  
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "Britain|Great Britain", "Great_Britain") 
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "United Kingdom|UK", "UK") 
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "New Caledonia", "New_Caledonia") 
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "Hong Kong", "Hong_Kong") 
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "Costa Rica", "Costa_Rica") 
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "South Africa", "South_Africa") 
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "United Arab Emirates", "UAE") 
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "South Korea", "South_Korea") 
rel.spdsht$addresses <-   str_replace_all(rel.spdsht$addresses, "Puerto Rico", "Puerto_Rico")
rel.spdsht$addresses <- str_replace_all(rel.spdsht$addresses,"Cayman Islands", "Cayman_Islands")
rel.spdsht$addresses <- str_replace_all(rel.spdsht$addresses,"Trinidad and Tobago", "Trinidad_and_Tobago")
rel.spdsht$addresses <- str_replace_all(rel.spdsht$addresses,"Virgin Islands (British)|Virgin Islands", "Virgin_Islands")
rel.spdsht$addresses <- str_replace_all(rel.spdsht$addresses,"St Kitts & Nevi", "StKitts_and_Nevi")
```
_4b. Split strings_  
```{r splitaddresses}
author.countries.df <- rel.spdsht %>% 
  mutate(edit.addresses=addresses,.after=addresses) %>% 
  mutate(edit.addresses=sub("\\Florida.*"," USA",edit.addresses)) %>% 
  mutate(edit.addresses=sub("\\Texas.*"," USA",edit.addresses)) %>% 
  mutate(edit.addresses=sub("\\FL.*"," USA",edit.addresses)) %>% 
  mutate(edit.addresses=sub("\\TX.*"," USA",edit.addresses)) %>% 
  mutate(edit.addresses=sub("\\New York.*"," USA",edit.addresses)) %>% 
  mutate(edit.addresses=sub("\\ILLINOIS.*"," USA",edit.addresses)) %>% 
  mutate(countries_all = (strsplit(edit.addresses,"\\[[^\\]]*\\](*SKIP)(*F)|\\h*;\\h*", perl=T) %>% 
                            lapply(.,function(x) {word(x,start=-1,sep=" ")}) %>% 
                            map_chr(.,toString) 
                          ),
                          .after=edit.addresses) %>% 
  separate(countries_all,into=c("first_authors","coauthors"),sep=",",extra="merge",remove=F)
```
## 5. Data frame manipulation    

_5a. Rename some values for ease of understanding_     
_Open access tiers_  
Diamond/Platinum = OA for readers at no cost to authors   
Gold = final version of article is open access immediately following publication   
Hybrid = available to subscribers to the journal but also freely available to everyone   
Green = pre-print/publisher's version can be archived; 'self archiving'   
```{r updateOA}
author.countries.df <- author.countries.df %>%
  mutate(OA=case_when(open_access=="NA" ~ "Not Open Access",
                      str_detect(open_access,"iamond|latinum") ~ "Diamond",
                           str_detect(open_access,"old") ~ "Gold",
                           str_detect(open_access,"reen") & !str_detect(open_access,"old") ~ "Green",
                           str_detect(open_access,"ronze") & !str_detect(open_access,"old") & !str_detect(open_access,"reen") ~ "Bronze",
                           str_detect(open_access,"ybrid") ~ "Hybrid",
                               .default=open_access),
         .after=open_access)
```
_Shorten paper category names_
```{r papercategory}
author.countries.df <- author.countries.df %>% 
  mutate(PaperType=case_when(`Type of Paper` == "Basic/descriptive science" ~ "A", 
                         `Type of Paper` == "Perspective/opinion" ~ "B", 
                         `Type of Paper` == "Applied science" ~ "C", 
                         .default="Not assigned"),
         .after=`Type of Paper`
         )
```
_Identify collaboration within MAR_  
Add information about whether there was collaboration with people in country  
```{r marcollab}
author.countries.df <- author.countries.df %>% 
  mutate(marfirst=case_when(str_detect(first_authors,
                                       "Mexico|Belize|Guatemala|Honduras") ~ "Lead",
                            str_detect(coauthors,
                                       "Mexico|Belize|Guatemala|Honduras") ~ "Coauthor",
                            .default="Not author"),
         .after="first_authors") 
```

_5b. Make figure data frames_    
Calculate how productive each country is and how that number changes over time  
```{r}
firstauthcountries.df <- author.countries.df %>% 
  add_count(first_authors,sort=TRUE,name="TotalPapersCountry") %>%  #count how many papers for each country
  #filter(n>1) %>%
  mutate(first_authors=factor(first_authors, #set names of country as factors
                              levels=unique(first_authors),ordered=TRUE)) %>% 
  ungroup() %>% group_by(year) %>% #group by year
  mutate(papers_peryear=n()) %>% #count number of total papers in a year
  ungroup() %>% group_by(year,first_authors,papers_peryear) %>% #group by year and country
  reframe(author_peryear=n(), #count number of papers coming out of a country in each year
          TotalPapersCountry=TotalPapersCountry) 
```
How many countries overall are involved in the papers we identified?  
```{r}
# unique countries publishing in the MAR 
all.countries <- lapply((author.countries.df %>% 
  separate_wider_delim(., #split a string into columns 
                       cols=countries_all,
                       delim=",", #delimiter between values to separate
                       names_sep="_", #output column names are separated with
                       too_few="align_start" #adds NA to any strings that are too short to fill in all columns
                       ) %>% 
    select(starts_with("countries"))),unique) %>% 
  c() %>% unlist() %>% 
  trimws(.,which="left") %>% unique()
```

```{r notthisoneIthink,eval=FALSE}
year.countries.df <-  author.countries.df %>% 
  separate_wider_delim(.,cols=countries_all, #separate the list of all author countries 
                       delim=",", #separate by comma
                       names_sep="_", #delimiter separating names of new columns
                       too_few="align_start") %>% #if there are uneven numbers, fill the remaining with NA  
  select(c(year,
           starts_with("Type"),
           language,
           starts_with("countr"))
         ) %>% #keep only year, type of paper, language, and country columns  
  #group_by(year) %>% summarize(across(starts_with("count"),n_distinct))
pivot_longer(cols=c(starts_with("countries")), #take all country columns and make each their own row. makes a new column 'name' with the column name each country value came from 
              #names_to="year",
              values_drop_na=TRUE
              ) %>% 
  mutate(value=trimws(value,which="left")) %>%
  group_by(year,value,name) %>% 
  mutate(firstauth=case_when(name=="countries_all_1" ~ n(), #get the count of number of first author papers for each country each year
                             .default=NA)) %>%
  ungroup() %>%
  group_by(year,value) %>% 
  reframe(countries_peryear = n(), #get the count of number of times an author from each country is published each year
            firstauth=unique(firstauth)) %>% 
  group_by(year,value) %>% 
  filter(n()>1 & !is.na(firstauth) | n()==1) %>% #filter out duplicate rows where a country has a first author 
  ungroup() %>% 
  group_by(value) %>% 
  mutate(total_percountry = sum(countries_peryear,na.rm=TRUE), #get the total number of times a country is in a published paper  
         total_firstauth = sum(firstauth,na.rm=TRUE)) %>% #get the total number of first author papers for each paper  
  ungroup() %>%
  add_count(value,sort=TRUE) %>% 
  mutate(value=factor(value,levels=rev(unique(value)),ordered=TRUE)) #order in descending order by the total number of papers
```
data frame to look at the country affiliation of ALL authors (first and coauthor)
```{r}
 year.countries.df <- author.countries.df %>% 
  separate_wider_delim(.,cols=countries_all, #separate the list of all author countries 
                       delim=",", #separate by comma
                       names_sep="_", #delimiter separating names of new columns
                       too_few="align_start") %>% #if there are uneven numbers, fill the remaining with NA  
  select(c(year,starts_with("Type"),language,starts_with("countr"))) %>% #keep only year, type of paper, language, and country columns  
  #group_by(year) %>% summarize(across(starts_with("count"),n_distinct))
pivot_longer(cols=c(starts_with("countries")), #take all country columns and make each their own row. makes a new column 'name' with the column name each country value came from 
              #names_to="year",
              values_drop_na=TRUE
              ) %>% 
  mutate(value=trimws(value,which="left")) %>%
  
  #### first, sum the country affiliation of each first author for each year #### 
  
  group_by(year,value,name) %>% 
  mutate(firstauth=case_when(name=="countries_all_1" & row_number() == 1 ~ n(), #get the count of number of first author papers for each country each year
                             .default=NA)) %>%
  
  #### next, sum the total participation: for ALL authors, how many are from each country each year? #### 
  
  ungroup() %>%
  group_by(year,value) %>% 
  mutate(total_percountry_peryear = case_when(
    row_number() == 1 ~ n(),
    .default=NA
  )) %>% #distinct() %>%
  #group_by(year,value) %>%  #filter(n()>1 & !is.na(firstauth) | n()==1) %>% #filter out duplicate rows where a country has a first author 
  
  #### then, sum the total participation: for ALL authors, how many are from each country? ####
  
  ungroup() %>% 
  group_by(value) %>% 
  mutate(total_percountry = case_when( row_number() == 1 ~ sum(total_percountry_peryear,na.rm=TRUE),
    .default=NA ), #get the total number of times a country is in a published paper  
    
  #### then, get the total number of first author papers for each country? ####
    
         total_firstauth = case_when(row_number() == 1 ~ sum(firstauth,na.rm=TRUE),
    .default=NA )
    ) %>% #get the total number of first author papers for each  
  ungroup() %>%
  select(-name) %>% distinct() %>%
  arrange(desc(total_percountry)) %>% 
  mutate(value=factor(value,levels=rev(unique(value)),ordered=TRUE)) #order in descending order by the total number of papers
```
```{r}
#check accuracy 
## should both be 309
sum(year.countries.df$firstauth,na.rm=TRUE)
sum(year.countries.df$total_firstauth,na.rm=TRUE)
```

## 6. Analysis: Countries  

```{r}
country.pal <- c("#2f4b7c",
"#a05195","#665191","#d45087",
"#f95d6a","#ff7c43","#ffa600",
"#003f5c","#4553c2", "#80b6aa", "#255026", "#49c32f", "#8e0049", "#fd5917", "#14c197", "#265582", "#d98ff4", "#7b038e", "#f75ef0", "#87a9fd", "#2524f9", "#85aa32", "#633d30", "#f5943b", "#a51409", "#fd8992", "#ff0087", "#c6a2ac",
"#78b4c6", "#016876", "#5faf66", "#1f3ca6", "#e689eb", "#841ea4", "#9a95e5", "#5b3c5e", "#f642d0", "#0b5313", "#f85582", "#943105", "#f9905b", "#972554", "#0ec61c", "#e8250c", "#55450a", "#cba662", "#270fe2","#e29578","#83c5be","#ffddd2","#9c89b8","#ffbe0b"
  )

scales::show_col(country.pal)

names(country.pal) <- unique(year.countries.df$value)
```

### Overall numbers  
*How many papers did we start with/end with?*  
```{r}
nrow(spdsht)
nrow(rel.spdsht)
```
454 papers -> 309 papers  
*does not include lines where reviewers have not reviewed articles yet* 

### Figure: Papers by country  
```{r}
year.country.ridgeplot <- ggplot(year.countries.df, aes(x=year,y=value,height=total_percountry_peryear,fill=value)) + 
  geom_density_ridges2(scale = 8,linewidth=.1,alpha=0.9,stat="identity",na.rm=TRUE) +
  #theme_ridges()  + 
  theme_bw() +
  scale_fill_manual(values=country.pal) + 
  ggpubr::labs_pubr() +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="none",
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) + 
  labs(title="Change in authored papers by year") 

year.country.ridgeplot

#ggsave("/Users/lauragivens/Downloads/roughdraft1.png",year.country.ridgeplot,width=15,height=10)
```

### Figure: Authorship  
```{r}
country.authors.dotplot <-  year.countries.df %>% group_by(year,value) %>% summarize(firstauth=sum(firstauth,na.rm=TRUE),total_percountry_peryear=sum(total_percountry_peryear,na.rm=TRUE)) %>% #year.countries.df %>% 
  ggplot(aes(x=year,y=value,color=firstauth)) + 
  geom_point(aes(size=total_percountry_peryear),alpha=0.95) + 
  scale_size_continuous(name="Number of \n authors",range=c(3,10),breaks=c(1,5,10,20,40,55)) +
  scale_color_gradientn(name="Number of \n first author \n publications",
                        colors=c("#d2ebf1","#219ebc","#176e83","#023047","#ffb703","#fb9d32","#fb8500")) + 
  scale_x_continuous(minor_breaks = seq(from=1960,to=2025,by=5)) +
  theme_bw() + 
  ggpubr::labs_pubr() +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="bottom",
        panel.grid.major.y = element_line(color="grey80")
        #panel.grid.minor.x = element_line(linetype=2,color="grey")
        ) + 
  guides(size=guide_legend(nrow=1,theme=theme(legend.key.size = unit(3, "point")))) +
  labs(title="Authors in papers published each year",
       caption="Points without a first author publication are colored in grey")

country.authors.dotplot

#ggsave("/Users/lauragivens/Downloads/roughdraft2.png",country.authors.dotplot,width=20,height=15)
```

### Figure: How many include authors from the region?    
In the previous figure we saw how the number of first author publications has changed, but what about overall?

```{r,warning=FALSE}
coauthor.plot <- author.countries.df %>% group_by(year,marfirst) %>% reframe(n=n()) %>% pivot_wider(names_from=marfirst,values_from=n,values_fill=0) %>% pivot_longer(cols=c("Not author","Lead","Coauthor")) %>% ungroup() %>% summarize("year"=year,"marfirst"=name,n=value) %>%
ggplot(.) + 
  geom_line(aes(x=year,y=n,group=marfirst,color=marfirst),linewidth=2.5) + viridis::scale_color_viridis(name="Papers including \n authors from the region",discrete=TRUE,option="D",begin=0.95,end=0) + 
  theme_bw() +
  scale_fill_manual(values=country.pal) + 
  ggpubr::labs_pubr()  +
  scale_x_continuous(name=NULL,limits=c(1990,2025),expand=c(0,0)) + 
  scale_y_continuous(name="Number of papers", 
                     limits=c(0,14),expand=c(0,0.5),
                     breaks=c(0,2,4,6,8,10,12,14))

coauthor.plot
```

```{r,warning=FALSE}
paper.marauth <- ggplot(author.countries.df) + 
  geom_bar(aes(x=year,fill=marfirst),color="black") + 
 # viridis::scale_fill_viridis(option="plasma",discrete=TRUE,end=0.9)
  scale_fill_manual(name="MAR authorship status",
                    values=c("#2a9d8f","#e76f51","grey70"),
                    na.value = "grey60") +
  scale_y_continuous(name="Number of articles",limits=c(0,25),expand=c(0,.5)) + 
  scale_x_continuous(limits=c(1990,2025)) +
  theme_bw() +
  ggpubr::labs_pubr()  +
  theme(text=element_text(size=20),
        #axis.title=element_blank(),
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) 

paper.marauth + viridis::scale_fill_viridis(option="viridis",discrete=TRUE,begin=0.1,end=0.99)
```

### Figure:  Accessibility     
Look at the type of paper (we're assuming applied science papers are more directly usable by managers) and accessibility (open access status) over time  
```{r}
paper.lang <- ggplot(author.countries.df) + 
  geom_bar(aes(x=year,fill=language),color="black") + 
  viridis::scale_fill_viridis(name="Published language",option="plasma",discrete=TRUE,begin=0.2,end=0.6)
#  scale_fill_manual(name="Published language",
 #                   values=c("#89a1ef","#5c8001"),
 #                   na.value = "grey60")

paper.type <- ggplot(author.countries.df) + 
  geom_bar(aes(x=year,fill=`Type of Paper`),color="black")  + 
  scale_y_continuous(expand=c(0,0),limits=c(0,25)) + 
  viridis::scale_fill_viridis(name="Type of research",option="plasma",discrete=TRUE,end=0.8) +
  #scale_fill_manual(name="Type of research",
  #                  values=c("#8338ec","#e07a5f","#3d405b"),
  #                  na.value = "grey60") + 
  guides(fill=guide_legend(nrow=2))

paper.oa <- ggplot(author.countries.df) + 
  geom_bar(aes(x=year,fill=OA),color="black") + 
  scale_y_continuous(expand=c(0,0),limits=c(0,25)) + 
  #viridis::scale_fill_viridis(name="Open access status",option="inferno",discrete=TRUE,begin=0.9,end=0.15)
  scale_fill_manual(name="Open access status",
                    values=c("#335c97","#e09f3e","#a3b369","#9e2a2b","grey50"),
                    na.value = "grey60") + guides(fill=guide_legend(nrow=2))
```

# PubFig: Country authorship over time   
Figure showing publication patterns for the 15 most productive countries.  
A. looks at how magnitude and participation in published research focused on the MAR has changed over time. The height of each country's ridge indicates the number of authors per year.   
B. looks at who is leading research in the MAR. Point size corresponds to the number of authors from that countries in published papers per year. The color of the point represents how many, if any, of those publications are first-author publications. 
```{r}
subs.country.authors.dotplot <- year.countries.df %>% group_by(year,value) %>% summarize(firstauth=sum(firstauth,na.rm=TRUE),total_percountry_peryear=sum(total_percountry_peryear,na.rm=TRUE)) %>% filter(value%in%top15) %>% filter(!is.na(firstauth) | !is.na(total_percountry_peryear)) %>%
  ggplot(aes(x=year,y=value,
             color=ifelse(!is.na(firstauth),firstauth,NA))) + 
  geom_point(aes(size=ifelse(!is.na(total_percountry_peryear),total_percountry_peryear,NA)),alpha=0.95) + 
  scale_size_continuous(name="Number of \n authors",range=c(3,10),breaks=c(1,5,10,20,40,55)) +
  scale_color_gradientn(name="Number of \n first author \n publications",
                        colors=c("grey","#219ebc","#176e83","#023047","#ffb703","#fb9d32","#fb8500")) + 
  scale_x_continuous(minor_breaks = seq(from=1960,to=2025,by=5)) +
  theme_bw() +
  ggpubr::labs_pubr() +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0)) + 
  theme(legend.position="top")+labs(caption=NULL)  +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        panel.grid.major.y = element_line(color="grey80")
        #panel.grid.minor.x = element_line(linetype=2,color="grey")
        ) + 
  guides(size=guide_legend(nrow=1,theme=theme(legend.key.size = unit(3, "point")))) +
  labs(title="Authors in papers published each year",
       caption="Points without a first author publication are colored in grey")

subs.year.country.ridgeplot <- year.countries.df %>% filter(value%in%top15) %>% 
  ggplot( aes(x=year,y=value,height=total_percountry_peryear,fill=value)) + 
  geom_density_ridges2(scale = 8,linewidth=.1,alpha=0.9,stat="identity",na.rm=TRUE) +
  #theme_ridges()  + 
  theme_bw() +
  scale_fill_manual(values=country.pal) + 
  ggpubr::labs_pubr()  +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0)) +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="none",
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) + 
  labs(title="Change in authored papers by year") 
```
```{r,warning=FALSE,message=FALSE}
country.authorship.wrapplot <- patchwork::wrap_plots(subs.year.country.ridgeplot,
                      subs.country.authors.dotplot + theme(legend.box = "vertical")
           )  +
  plot_layout(widths=c(8,10),design="
              A#
              AB
              AB
              AB
              AB
              AB
              AB
              AB")  + 
  plot_annotation(title="Availability of evidence to inform marine conservation management in the Mesoamerican Reef Ecoregion") & theme(text=element_text(size=16),plot.title=element_blank())

country.authorship.wrapplot
#ggsave("/Users/lauragivens/Downloads/country.authorship.wrapplot.png",width=15,height=7,bg="white")
```
```{r warning=FALSE,message=FALSE}
country.authorship.wrapplot.2 <- patchwork::wrap_plots(subs.country.authors.dotplot,
                                                     coauthor.plot
                                                     )  +
  plot_layout(widths=c(10,7))  + 
  plot_annotation(tag_levels="A", tag_suffix = ".") &
  theme(text=element_text(size=16),
        plot.title=element_blank(),
        #legend.box="vertical",
        legend.position="bottom")

country.authorship.wrapplot.2
#ggsave("/Users/lauragivens/Downloads/country.authorship.wrapplot.2.png",width=14,height=8,bg="white")
```

Over time, authors from more countries were participating in research focused in the MAR and the number of publications per year increases as well. Authors from a total of 43 countries were involved in publishing research set in the MAR. Of those, 29 countries had at least one first author publication. Authors from Mexico and the United States were the most productive, with 107 and 108 first author publications, respectively. 

#### Analysis: Authorship  

##### Number of countries  
Where are most authors coming from?  

*How many countries have been involved in scientific articles regarding the MAR?*    
```{r}
length(all.countries[!is.na(all.countries)])
```
45 countries  

*Most productive countries overall? (including first and coauthors)*  
```{r}
top10 <- year.countries.df %>% arrange(desc(total_percountry)) %>% .$value %>% unique() %>% .[1:10]

top15 <- year.countries.df %>% filter(value != "NA") %>% arrange(desc(total_percountry)) %>% .$value %>% unique() %>% .[1:15]

top10
```
Mexico comes in first, followed by US and UK  

Do those super productive countries change if we only look at the last 10 years? How about 5? 
```{r}
top10.2015 <- year.countries.df %>% filter(year>2015) %>% group_by(value) %>% mutate(newtotal=sum(total_percountry_peryear,na.rm = TRUE)) %>% arrange(desc(newtotal)) %>% .$value %>% unique() %>% .[1:10]

top10.2020 <- year.countries.df %>% filter(year>2020) %>% group_by(value) %>% mutate(newtotal=sum(total_percountry_peryear,na.rm = TRUE)) %>% arrange(desc(newtotal)) %>% .$value %>% unique() %>% .[1:10]

top10.2015
top10.2020
```
Minor changes after US and Mexico, but nothing substantial I think.  

How productive are these countries?  
```{r}
year.countries.df %>% filter(value %in%top10) %>% select(c(value,total_percountry,total_firstauth))
```

*Who was publishing early?*  
```{r}
year.countries.df %>% filter(year < 2006) %>% select(c(year,value,firstauth,total_percountry_peryear,total_firstauth)) %>% distinct() %>% arrange(year)
```

```{r}
year.countries.df %>% filter(year < 2006) %>% select(c(year,value,firstauth,total_percountry_peryear,total_firstauth)) %>% 
  group_by(value) %>% 
  summarize(first=sum(firstauth,na.rm=TRUE),
            total=sum(total_percountry_peryear,na.rm=TRUE))
```

```{r}
length(year.countries.df %>% filter(year < 2006) %>% .$value %>% unique())
year.countries.df %>% filter(year < 2006) %>% .$value %>% unique()
```

```{r}
length(year.countries.df %>% filter(year > 2006) %>% .$value %>% unique())
year.countries.df %>% filter(year > 2006) %>% .$value %>% unique()
```

##### Number of first author countries?  
```{r}
firstauthcountries.df %>% .$first_authors %>% unique() %>% length()
```
31 different countries were first authors  
and of those 31, the USA had the most number of first author publications closely followed by Mexico, with the UK in a distant 3rd 
```{r}
firstauthcountries.df %>% filter(!duplicated(first_authors)) %>% arrange(desc(TotalPapersCountry)) %>% .$first_authors
#double check that math is right: does TotalPapersCountry add up to the total number of papers? 
#firstauthcountries.df %>% filter(!duplicated(first_authors)) %>% .$TotalPapersCountry %>% sum() #totals 309
```

##### Percent authorship    
```{r}
participation.df <- author.countries.df %>% 
  group_by(year,marfirst) %>% 
  summarize(n=n()) %>% 
  pivot_wider(names_from="marfirst",values_from="n") %>% 
  mutate(total=sum(`Not author`,Lead,Coauthor,na.rm=TRUE),
         perc=sum(Lead,Coauthor,na.rm = TRUE)/total,
         leadperc=sum(Lead,na.rm=TRUE)/total
         ) %>% arrange(desc(year))

participation.df
```
Prior to 2006, only 1-2 papers focusing on the MAR were published each year   
```{r}
participation.df %>% filter(year<2006 & total>0) %>% .$total %>% range()
```
Prior to 2000, only 1-2 papers focusing on the MAR were published each year   
```{r}
participation.df %>% filter(year<2000 & total>0) %>% .$total %>% range()
```
15% of those papers included someone from within the region in the authorship list.   
```{r}
participation.df %>% filter(year<2000 & total>0) %>% .$perc %>% mean()
```
Publishing began to increase after 2006, breaking the double digits  
```{r}
participation.df %>% filter(year>2000 & year<2011)
```
```{r}
participation.df %>% filter(year>2006 & year<2014) %>% .$perc %>% mean(.,na.rm=TRUE)
participation.df %>% filter(year>2006 & year<2014) %>% .$leadperc %>% mean(.,na.rm=TRUE)
```

In the last ten years, 48.41% of papers have included someone from within country, 42.33% of which were led by the first author.   
```{r}
participation.df %>% filter(year>2014 & year <2025) %>% .$total %>% range(.,na.rm=TRUE)
participation.df %>% filter(year>2014 & year <2025) %>% .$perc %>% mean(.,na.rm=TRUE)

participation.df %>% filter(year>2014 & year <2025) %>% .$leadperc %>% mean(.,na.rm=TRUE)
```

# PubFig: Accessibility  
```{r accessplot}
accessibility.plot <- wrap_plots(paper.type,paper.oa) + 
  plot_annotation(tag_levels="A",tag_suffix = ".") & theme_bw() + 
  ggpubr::labs_pubr()  + 
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="bottom",
        panel.grid.major.y = element_line(color="grey80"),
        line = element_line(linewidth=0.5)
        )

accessibility.plot
#ggsave(filename="/Users/lauragivens/Downloads/MAR_litaccess.plot.png",plot=accessibility.plot,height=5,width=15,bg="white")
```

#### Analysis: Percent access    

##### Percent basic vs percent applied  
```{r,warning=FALSE,message=FALSE}
applied.df <- author.countries.df %>% group_by(year,`Type of Paper`) %>% 
  summarize(n=n()) %>% 
  mutate(`Type of Paper`=case_when(is.na(`Type of Paper`) ~ "Unknown",
                                   .default=`Type of Paper`)) %>% 
  mutate(across(where(is.character), str_replace_all, replacement="_", pattern=" ")) %>% 
  pivot_wider(names_from=`Type of Paper`,values_from="n",values_fill=0) %>% 
  column_to_rownames(.,"year") %>% 
  mutate(total=rowSums(.,na.rm=TRUE),
         perc=round(Applied_science/total,digits=4)
         ) 
```
```{r}
applied.df
```
```{r}
applied.df %>% filter(rownames(.)>2014) %>% .$perc %>% mean()
```

##### Percent open access  
```{r}
oa.df <- author.countries.df %>% group_by(year, OA) %>% 
  summarize(n=n())%>% 
  pivot_wider(names_from=OA,values_from="n",values_fill=0) %>% 
  column_to_rownames(.,"year") %>% 
  mutate(total=rowSums(.,na.rm=TRUE),
         year=rownames(.)) %>% rowwise() %>% 
        mutate( perc=round(sum(Bronze,Gold,Green,Hybrid,na.rm=TRUE)/total,digits=4)
  ) %>% column_to_rownames(.,"year") 
```
```{r}
oa.df
```
```{r}
oa.df %>% filter(rownames(.)>2015) %>% .$perc %>% mean()
```

```{r}
arrange(oa.df,desc(perc))[1:10,]
```

##### Percent English  
```{r}
lang.df <- author.countries.df %>% group_by(year,language) %>% 
  summarize(n=n()) %>% 
  pivot_wider(names_from=language,values_from="n",values_fill=0) %>% 
  column_to_rownames(.,"year") %>% 
  mutate(total=rowSums(.,na.rm=TRUE),
         perc=round(Spanish/total,digits=4)
         ) 
```
```{r}
lang.df
```
```{r}
mean(lang.df$perc)
```

Across all years with more than one published paper, only 3.42% of papers were published in Spanish  
```{r}
lang.df %>% filter(total>1) %>% .$perc %>% mean()
```
In the last decade, only 1.36% of papers were published in Spanish    
```{r}
lang.df %>% filter(rownames(.) > 2014) %>% .$perc %>% mean()
```


## 7. Analysis: Ecosystems  

#### Regional focus  
```{r}
eco.df <- author.countries.df %>% 
  separate_wider_delim(.,cols=countries_all, #separate the list of all author countries 
                       delim=",", #separate by comma
                       names_sep="_", #delimiter separating names of new columns
                       too_few="align_start")  %>% 
  
  rename(.,"FocusGeography"="Paper Geographical Area of Focus",
         "Management"="Marine Management  - mention/focus",
         "MPA"="Marine Management  - mention/focus",
         "MP"="Protected Area Management Plans - mention/focus" ,
         "Policy"="Policy/Law/Legislation/Framework or governance - mention/focus",
         "GeoFocus"="Focus on geomorphology/physical characteristics") %>% 
  
  separate_wider_delim(.,cols="FocusGeography", #separate the list of all author countries 
                       delim=",", #separate by comma
                       names_sep="_", #delimiter separating names of new columns
                       too_few="align_start")

```
```{r}
geo.plot <- pivot_longer(eco.df,cols=starts_with("FocusGeo")) %>% 
  mutate(RegionOfFocus=trimws(value,which="both"),.before="PaperType",
         RegionOfFocus=case_when(RegionOfFocus=="ExpandMAR" ~ "Larger Region",
                                 RegionOfFocus=="MAR" ~ "Entire MAR",
                                 .default=RegionOfFocus),
         RegionOfFocus=factor(RegionOfFocus,levels=c("Belize","Guatemala","Honduras","Mexico","Entire MAR","Larger Region"))) %>%
  filter(.,!is.na(RegionOfFocus)) %>% 
  ggplot(aes(x=RegionOfFocus,fill=RegionOfFocus)) +
  geom_bar(stat="count",position="stack") + 
  labs(x="Geographic Focus of Paper",
       y="Number of Papers") + 
  viridis::scale_fill_viridis(option="C",discrete=TRUE,end=0.9) + 
  guides(fill=guide_legend()) +
  theme_bw() +
  ggpubr::labs_pubr()  +
  scale_y_continuous(expand = c(0,2)) +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="none",
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) + 
  labs(title="Geographical study area") 

geo.plot
```
```{r}
geo.table <- pivot_longer(eco.df,cols=starts_with("FocusGeo")) %>% 
  mutate(RegionOfFocus=trimws(value,which="both"),.before="PaperType",
         RegionOfFocus=case_when(RegionOfFocus=="ExpandMAR" ~ "Larger Region",
                                 RegionOfFocus=="MAR" ~ "Entire MAR",
                                 .default=RegionOfFocus),
         RegionOfFocus=factor(RegionOfFocus,levels=c("Belize","Guatemala","Honduras","Mexico","Entire MAR","Larger Region"))) %>%
  filter(.,!is.na(RegionOfFocus)) %>% 
  group_by(RegionOfFocus) %>% 
  reframe(NumberOfPapers=n()) %>% 
  arrange(desc(NumberOfPapers)) %>% flextable::flextable(.) %>% flextable::set_header_labels(RegionOfFocus="Geographical Focus",NumberOfPapers="Number of Papers") %>%
  #flextable::set_table_properties(layout="autofit") %>% 
  flextable::theme_zebra() %>%
  flextable::fontsize(size=15,part="all")

geo.table
```

```{r}
geo.plot + inset_element(
    gen_grob(geo.table, fit = "width"),
    left = 0.65, bottom = .65, 
    right = 1, top = 1
  )  + theme(
    plot.background = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent")
  )
```

```{r,eval=FALSE}
pivot_longer(eco.df,cols=starts_with("FocusGeo")) %>% 
  mutate(RegionOfFocus=trimws(value,which="both"),.before="PaperType",
         RegionOfFocus=factor(RegionOfFocus,levels=c("Belize","Guatemala","Honduras","Mexico","MAR","ExpandMAR"))) %>%
  group_by(RegionOfFocus) %>% 
  filter(.,!is.na(RegionOfFocus)) %>% ggplot(., aes(x=year,y=RegionOfFocus,height=total_peryear,fill=RegionOfFocus)) + 
  geom_density_ridges2(scale = 8,linewidth=.1,alpha=0.9,stat="identity",na.rm=TRUE) +
  #theme_ridges()  + 
  theme_bw() +
  scale_fill_manual(values=country.pal) + 
  ggpubr::labs_pubr() +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="none",
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) + 
  labs(title="Change in authored papers by year") 
```

#### Ecosystem focus
```{r}
geo.df <- eco.df %>% 
  select(c(year,starts_with("countr"), #keep all the country affiliations of the authors  
           GeoFocus,`Focus on Mangrove`,`Focus on Coral`,`Focus on Seagrass`) #keep the ecosystem topics 
         ) %>% 
  pivot_longer(cols=c(GeoFocus,`Focus on Mangrove`,`Focus on Coral`,`Focus on Seagrass`)) %>% #collapse all of the ecosystem focus options into one column  
  mutate(value=case_when(value=="Unsure - flag to review later" ~ NA, #change unsures to NA
                         value=="No" ~ NA, #change No to NA 
                         .default=value),
         name=case_when(name=="GeoFocus" ~ "Geomorphology",
                        name=="Focus on Seagrass" ~ "Seagrass",
                        name=="Focus on Coral" ~ "Coral",
                        name=="Focus on Mangrove" ~ "Mangrove",
                        .default=name))  %>% 
  rename("Focus"="name", 
         "FocusY"="value") %>% 
  pivot_longer(cols=c(starts_with("countr"))) %>% #collapse all of the countries into one column  
  filter(!is.na(value) & !is.na(FocusY)) %>% 
  group_by(year,value,name) %>% 
  mutate(firstauth=case_when(name=="countries_all_1" & row_number() == 1 ~ n(), #get the count of number of first author papers for each country each year
                             .default=NA),
         value=str_trim(value,side="both")) %>%
  ungroup() %>%
  group_by(year,value,Focus) %>% 
  mutate(focus_peryear = n()) %>%
  select(-c(name,FocusY)) %>%
  distinct() %>% 
  ungroup() %>% group_by(value) %>% 
  mutate(n=n()) %>% #sum the total number of times a country appears in the list
  #filter(n>1) %>%
  arrange(n) %>% 
  mutate(value=factor(value,levels=unique(.$value),ordered=TRUE)) 
```

```{r}
papernum.ecosystem.plot <- geo.df %>%
  ggplot(aes(x=Focus,fill=Focus)) + geom_bar(stat="count") + 
  viridis::scale_fill_viridis(discrete=TRUE,option="C",end=0) + 
  labs(title="Number of papers focusing on different marine ecosystem types") +
  theme_bw() +
  ggpubr::labs_pubr()  +
  scale_y_continuous(expand = c(0,4)) +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        axis.text.x = element_text(angle=45,vjust=1,hjust=1),
        legend.position="none",
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) 

papernum.ecosystem.plot
```

```{r}
eco.table <- geo.df %>% group_by(value,Focus) %>% 
  summarize(n=n()) %>% 
  pivot_wider(names_from=Focus,values_from=n,values_fill=0) %>% 
  filter(value%in%top15) %>%
  column_to_rownames(.,"value") %>% 
  mutate(Total=rowSums(.,na.rm=TRUE)) %>% #filter(Total>1) %>%
  rownames_to_column("Country") %>%
  arrange(desc(Total)) %>% 
  bind_rows(summarise(.,across(where(is.numeric),sum),
                      across(where(is.character),~"Total"))) %>% 
  flextable::flextable(.) %>% 
  flextable::set_header_labels("Geomorphology"="Geo.") %>%
  flextable::theme_zebra() %>%
  #flextable::set_table_properties(layout="autofit") %>% 
  flextable::fontsize(size=20,part="all") %>% hline(i=14) %>% vline(j=5) %>%
  flextable::bold(i=15) %>% flextable::italic(j=6)
```

```{r}
country.ecosystem.plot <- geo.df %>%
  filter(value%in%top15) %>%
ggplot(., aes(x=year,y=value,
              height=focus_peryear,fill=value)) + 
  geom_density_ridges2(scale = 5,linewidth=.1,alpha=0.9,stat="identity",na.rm=TRUE) + 
facet_wrap(~Focus) +
  theme_bw() +
  scale_fill_manual(values=country.pal) + 
  ggpubr::labs_pubr()  +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0)) +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="none",
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) +
  labs(title="Change in manuscript focus over time by country") 

country.ecosystem.plot
```

# PubFig: Ecosystem focus  
```{r}
wrap_plots(country.ecosystem.plot+labs(title=NULL),
           papernum.ecosystem.plot+labs(title=NULL),
    gen_grob(geo.table, fit = "width")
  ) + plot_layout(design="
                  AAB
                  AAB
                  AAC") 

#ggsave("/Users/lauragivens/Downloads/paperfocus.png",width=12,height=8,bg="white")
```
```{r}
wrap_plots(country.ecosystem.plot+labs(title=NULL),
           plot_spacer(),
    gen_grob(eco.table, fit = "width"),
    gen_grob(geo.table, fit = "width")
  ) + plot_layout(design="
                  ABC
                  ABC
                  ABD",widths=c(6,0.5,4,4)) 

#ggsave("/Users/lauragivens/Downloads/paperfocus.2.png",width=12,height=8,bg="white")
```

## Analysis: Ecosystem    

### Percentage by ecosystem  
Percentage of papers focused on each ecosystem - is there a bias?  
```{r}
geo.df %>% group_by(Focus) %>% summarize(n=n(),
                                         perc=round(n/nrow(.),digits=4) )
```
```{r}
geo.df %>% group_by(year,Focus) %>% 
  summarize(n=n()) %>% 
  ungroup() %>% group_by(year) %>% 
  mutate(x=sum(n),
         perc=round(n/x,digits=4)) 
```

```{r}
geo.df %>% group_by(year,Focus) %>% 
  summarize(n=n()) %>% 
  ungroup() %>% group_by(year) %>% 
  mutate(x=sum(n),
         perc=round(n/x,digits=4)) %>% 
  ggplot(aes(x=year,y=perc)) + geom_line(aes(color=Focus),linewidth=1) + scale_x_continuous(limits=c(1990,2025))
```

### Countries  
```{r}
pivot_longer(eco.df,cols=starts_with("FocusGeo")) %>% 
  mutate(RegionOfFocus=trimws(value,which="both"),.before="PaperType",
         RegionOfFocus=case_when(RegionOfFocus=="ExpandMAR" ~ "Larger Region",
                                 RegionOfFocus=="MAR" ~ "Entire MAR",
                                 .default=RegionOfFocus),
         RegionOfFocus=factor(RegionOfFocus,levels=c("Belize","Guatemala","Honduras","Mexico","Entire MAR","Larger Region"))) %>%
  filter(.,!is.na(RegionOfFocus)) %>% 
  group_by(RegionOfFocus) %>% 
  reframe(NumberOfPapers=n()) %>% 
  arrange(desc(NumberOfPapers)) %>% #%>% aov(NumberOfPapers~RegionOfFocus,.) %>% TukeyHSD()
  mutate(perc=NumberOfPapers/sum(NumberOfPapers)) 
```

```{r}
geo.df %>% group_by(value,Focus) %>% 
  summarize(n=n()) %>% 
  #pivot_wider(names_from=Focus,values_from=n,values_fill=0) %>% 
  filter(value%in%top15) #%>% aov(n~value,.) %>% TukeyHSD()
```

```{r}
geo.df %>% group_by(value,Focus) %>% 
  summarize(n=n()) %>% 
  #pivot_wider(names_from=Focus,values_from=n,values_fill=0) %>% 
  filter(value%in%top15) %>%
  #column_to_rownames(.,"value") %>% 
  #mutate(Total=rowSums(.,na.rm=TRUE)) %>% #filter(Total>1) %>%
  #arrange(desc(Total))  %>% rownames_to_column("value") %>%
  glm(n ~ value+Focus,data=.,
      family=gaussian,
      na.action=na.exclude
      ) %>% summary()
```


## Analysis: Geography  
Map?  

## Analysis: Fisheries  
possible to loop into / include in ecosystem paper? Call it major themes or something?

# ~~~~~
```{r}
#can check that the replacement worked  
#AuthorList
#AuthorListrep

#only issue I think is #406
#[[406]]
#[1] "FL 33149" "TX 77843"

#check we'd only be replacing those values  
grepl("FL|TX",AuthorListrep) %>% summary() 
# TRUE=1
grepl("FL|TX",FirstAuthorsrep) %>% summary() 
grepl("FL|TX",CoAuthorsrep) %>% summary() 

AuthorListreps <- rapply(AuthorListrep, function(x) ifelse(grepl("FL|TX",x),"United States of America",x), how = "replace")
FirstAuthorsreps <- rapply(FirstAuthorsrep, function(x) ifelse(grepl("FL|TX",x),"United States of America",x), how = "replace")
CoAuthorsreps <- rapply(CoAuthorsrep, function(x) ifelse(grepl("FL|TX",x),"United States of America",x), how = "replace")
#AuthorListreps
```

dealing with duplicate addresses  
Trying to duplicate addresses for authors who were lumped together in square brackets because they're from the same institution 
Come  back to this  
```{r,eval=FALSE}
#strsplit(countries$addresses,"\\[[^\\]]*\\](*SKIP)(*F)|\\h*;\\h*", perl=T)
countries %>% 
  filter(str_detect(addresses,"]") ) %>% 
  mutate(n=str_count(
    addresses, 
    str_match(string=";",
              pattern="\\[(;)\\]"
              )
    ), 
    .after=authors)



str_match_all(string=countries$addresses,pattern=";") %>% head()

countries %>% 
  filter(str_detect(addresses,"]") ) %>% .$addresses %>% str_extract_all(.,"\\[(.*?)\\]") %>% map_chr(.,toString) %>% head()
```
```{r,eval=FALSE}
countries %>% select(c(authors,addresses)) %>% mutate(newauth=str_count(authors,pattern=";"),
                      newadd=str_count(addresses,pattern=";"),
                      same=(newauth==newadd)) %>% filter(same==FALSE) 
```

```{r}
year.country.ridgeplot2 <- year.country.ridgeplot +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0)) 

country.authors.dotplot2 <- country.authors.dotplot +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0))
```

```{r}
patchwork::wrap_plots((country.authors.dotplot2+theme(legend.position="top")+labs(caption=NULL)), #dotplot: country vs year, size of dot = number of papers that year, color=number of first authors
           free(year.country.ridgeplot2) #ridgeplot: country vs year
           )  +
  plot_layout(widths=c(10,8))  + 
  plot_annotation(title="Availability of evidence to inform marine conservation management in the Mesoamerican Reef Ecoregion",
                  tag_levels="A",tag_suffix=".") & theme(text=element_text(size=16),plot.title=element_blank())

#ggsave("/Users/lauragivens/Downloads/pubovertime.png",width=20,height=12)
```

# Maps  
```{r,warning=FALSE}
library(geodata)
globe <- map_data("world")
globe.mar <- full_join(globe,
                       (year.countries.df %>% 
                          group_by(value) %>% 
                          mutate(firstauth=sum(firstauth,na.rm=TRUE),
                                 region=str_replace_all(value,"_"," ")) 
                        ))

cons <- geodata::country_codes()
```

```{r,warning=FALSE,message=FALSE}
mar <- map_data("world",region=c("Mexico","Belize","Guatemala","Honduras",
                                 "Nicaragua","Costa Rica","Panama",
                                 #"Cuba","Haiti",
                                 "Venezuela","Colombia"#,
                                 #"Dominican Republic",
                                 #"Puerto Rico","Jamaica",
                                 #"Trinidad and Tobago",
                                 #"Cayman Islands",
                                 #"Virgin Islands",
                                 #"Barbados"
                                 ))


# Compute the centroid as the mean longitude and lattitude
# Used as label coordinate for country's names
mar.labs <- mar %>%
  group_by(region) %>%
  summarise(
    long = case_when(
      region%in%c("Guatemala","Mexico","Honduras","Belize") ~ mean(long)),
      lat = case_when( region%in%c("Guatemala","Mexico","Honduras","Belize")~mean(lat))
    )

cols <- viridis::viridis(4)
names(cols) <- c("Belize","Honduras","Mexico","Guatemala")
scales::show_col(cols)

ggplot(mar,aes(x=long,y=lat)) + geom_polygon(aes(group=group,fill=ifelse(region%in%c("Guatemala","Mexico","Honduras","Belize"),region,NA)),color="black")  +
  #geom_text(aes(label = region), data = mar.labs,  size = 3, hjust = 0.5)+
  #scale_fill_viridis_d() +
  scale_fill_manual(values=cols) +
  theme_void() +
  theme(legend.position = "none")

#ggsave("/Users/lauragivens/Downloads/map.png",width=10,height=7)
```
```{r}
geo.df %>% group_by(value) %>% 
  select(-c(firstauth,n)) %>% 
  group_by(value,Focus) %>% 
  reframe(n=sum(focus_peryear)) %>% 
  filter(value=="Belize" | value == "Honduras" | value=="Guatemala" | value=="Mexico") %>%
  group_by(value) %>% 
  mutate(frac=n/sum(n)) %>%
  ggplot(aes(group=Focus,x="",y=frac,fill=Focus)) + 
  geom_bar(stat="identity",width=1,color="black") + 
  coord_polar("y",start=0) + 
  facet_wrap(~value) + 
  scale_fill_brewer(name="Proportion of papers",palette="Set3") + 
  theme_void() 

#ggsave("/Users/lauragivens/Downloads/piechrt.png",bg="transparent")
```


All countries 
```{r}
ggplot() + geom_polygon(data=globe.mar,aes(x=long,y=lat,group=group,fill=!is.na(value)),color="black") +
  scale_fill_manual(name="Countries publishing MAR research",values=c("lightgrey","#2a9d8f")) + 
  ggpubr::theme_pubclean() +
  theme(axis.title=element_blank(),axis.text=element_blank(),axis.ticks = element_blank(),legend.position="none")

#ggsave("/Users/lauragivens/Downloads/mar.map.png",width=8,height=5)
```

First author countries  
```{r}
ggplot() + 
  geom_polygon(data=globe.mar,
               aes(x=long,y=lat,
                   group=group,
                   fill=ifelse(total_firstauth>0,!is.na(total_firstauth),NA)),color="black") + 
  scale_fill_manual(name="Countries publishing MAR research",
                    values=c("#f4a261"),
                    na.value = "lightgrey") + 
  ggpubr::theme_pubclean() +
  theme(axis.title=element_blank(),axis.text=element_blank(),axis.ticks = element_blank(),legend.position="none") 

#ggsave("/Users/lauragivens/Downloads/mar.firstauth.map.png",width=8,height=5)
```

```{r}
ggplot(data=globe.mar) +
  geom_polygon(aes(x=long,y=lat,group=group,fill=total_percountry),color="black") + 
  geom_point(aes(x=long,y=lat,
                 color=total_firstauth,group=group,
                 size=ifelse(total_firstauth>0 & !duplicated(value),total_firstauth,NA))) + 
  scale_size(name="First author pubs",
             breaks=c(1,10,20,30,60,90,120,150),
             range=c(4,12)) + 
  scale_fill_viridis_b(name="Total publications",
                       option="F",
                       begin=0.2,end=0.9,
                       na.value="lightgrey",
                       breaks=c(1,10,20,30,60,90,120,150)) + 
  scale_color_gradientn(name="First author pubs",
                        na.value = "lightgrey",colors=rev(c("#264653","#2a9d8f","#e9c46a","#f4a261")),
  #scale_color_gradientn(na.value = "lightgrey",colors=c("#8ecae6","#219ebc","#023047","#ffb703","#fb8500"),
                       breaks=waiver(),n.breaks=10 ) + 
  theme_bw() + theme(legend.position="top")
```

# other figs  
```{r}
firstauthcountries.df %>% ggplot(aes(x=year,fill=first_authors)) + geom_bar()
firstauthcountries.df %>% ggplot(aes(x=year,y=papers_peryear,fill=first_authors)) + geom_bar(stat="identity",position="dodge")
```

```{r}
firstauthcountries.df %>% filter(n>2) %>% ggplot(aes(x=year,y=first_authors,fill=first_authors)) + 
  geom_density_ridges2(scale = 5,linewidth=1.3,alpha=0.9) +
  theme_ridges() + theme(legend.position="none")

#ggsave("/Users/lauragivens/Downloads/roughdraft.png",width=15,height=7)
```
```{r}
firstauthcountries.df %>% filter(n>2) %>% ggplot(aes(x=year,y=first_authors,fill=first_authors)) + 
  geom_density_ridges2(scale = 5,linewidth=1.3,alpha=0.9) +
  theme_ridges() + theme(legend.position="none")
```

```{r,warning=FALSE}
year.countries.df %>% 
ggplot() + 
  geom_point(aes(x=ifelse(total_percountry>0 & !duplicated(value),total_percountry,NA),y=value),alpha=0.7) + 
  geom_point(aes(x=ifelse(total_firstauth>0 & !duplicated(value),total_firstauth,NA),y=value),alpha=0.9,color="red") +
  theme_bw() + 
  ggpubr::labs_pubr() +
  theme(text=element_text(size=20),
        axis.title.y=element_blank(),
        panel.grid.major.y = element_line(color="grey80")
        #panel.grid.minor.x = element_line(linetype=2,color="grey")
        ) + 
  guides(size=guide_legend(nrow=1)) +
  labs(title="Country affiliation of authors of papers published ",
       caption="First author country affiliation colored in red",
       x="Number of authors")

#ggsave("/Users/lauragivens/Downloads/roughdraft4.png",width=10,height=15)
```
```{r}
scales::show_col(viridis::viridis_pal(option="D",begin=0,end=1)(5))
scales::show_col(viridis::viridis_pal(option="C",begin=0,end=1)(5))
scales::show_col(viridis::viridis_pal(option="B",begin=0.1,end=0.9)(5))
scales::show_col(viridis::viridis_pal(option="A",begin=0.2,end=0.9)(5))

country.pal2 <- c(
                  viridis::viridis_pal(option="D",begin=0,end=1)(5),
                  "#2f4b7c","#a05195","#665191","#d45087","#f95d6a",
                  rev(viridis::viridis_pal(option="C",begin=0,end=1)(5)),
                  "#ff7c43","#ffa600",
                  viridis::viridis_pal(option="B",begin=0.1,end=0.8)(5),
                  viridis::viridis_pal(option="A",begin=0.2,end=0.9)(5)
                  )

scales::show_col(country.pal2)
```

```{r}
firstauthcountries.df %>% filter(n>2) %>% ggplot(aes(x=year,y=first_authors,fill=first_authors)) + 
  geom_density_ridges2(scale = 5,linewidth=1.3,alpha=0.9) +
  theme_ridges() + theme(legend.position="none")

year.countries.df %>% ggplot(aes(x=year,y=value,height=total_percountry_peryear,fill=value)) + 
  #geom_density_ridges2(scale = 5,linewidth=1.3,alpha=0.9) +
  geom_ridgeline(scale=1,linewidth=1,alpha=0.6) +
  theme_ridges() + theme(legend.position="none")
```


```{r}
save.image("~/Documents/GitHubRepos/MARLitReview/.RData")
sessionInfo()
```

