---
title: "Author Countries"
author: "Laura Givens"
date: "2025-05-20"
output: html_document
---
```{r}
library(readxl)
library(readr)
library(stringr)
library(ggplot2)
library(ggridges)
library(tidyverse)
library(patchwork)
```

Get list of addresses from file (made by copy/pasting the column from the lit review spreadsheet 20-5-2025)  
```{r}
countries <- read_tsv("mar_litreview_addresses.tsv")
newcountries <- read_tsv("mar_litreview_onlyrelevant.tsv")
IsraelMergedDB <- read.csv("Merged and cleaned database for literature review.csv")
```
How many papers?  
```{r}
nrow(countries)
```

There is one line per paper; each line is made up of a list of all coauthor institutions 
```{r}
head(countries)
```

Split each line at the semicolon, which makes a nested list. The countries2 list has 454 elements, which corresponds to the 454 papers. Each of those elements has one sub-element per address.    
* List  
  - Paper 1  
      > address 1  
      > address 2  
      > address 3  
  - Paper 2  
      > address 1  
      > address 2  

We use regex to skip everything inside the square brackets, then split each line into addresses by semicolon like we did above.  

```{r}
addresses <- strsplit(countries$addresses,"\\[[^\\]]*\\](*SKIP)(*F)|\\h*;\\h*", perl=T)
tail(addresses)
```
```{r}
rep.addresses <- rapply(addresses, function(x) ifelse(grepl("US|States",x),"USA",x), how = "replace")
```

```{r}
#countries2 <- str_split(countries$addresses,";") 
#tail(countries2)
```

We originally grabbed the country of each author by selecting everything after the last comma ","  
```{r}
authors <- lapply(rep.addresses,function(x) {word(x,start=-1,sep=",")}) 
head(authors)

tail(authors)
```

To get the country of each first author, we take the first sub-element of every element in the list.  
```{r}
firstauth <- lapply(authors,function(x) x[[1]])
head(firstauth)
```

To get the countries of all other authors, we remove the first sub-element of every element in the list.  
```{r}
coauth <- lapply(authors,function(x) x[-1])
head(coauth)
```

However, we also have a few addresses that were added to the spreadsheet in a different way. These look to be split by institution.  

# Address unusual author address  
```{r}
countries[364:454,] %>% head()
```


Then we can grab everything after the last comma to get author country.  
```{r}
authors2 <- lapply(countries3,function(x) {word(x,start=-1,sep=",")})
#head(authors2)
```

```{r}
firstauth2 <- lapply(authors2,function(x) x[[1]])
#head(firstauth2)
```

```{r}
coauth2 <- lapply(authors2,function(x) x[-1])
#head(coauth2)
```

# Combine and clean up    
```{r}
length(authors) #check length of author list
authors[-c(364:454)] %>% length() #check length of author list minus the ones that had a different structure 
length(authors2) #check length of our unusual author list
#should equal the same amount  

AuthorList <- c(authors[-c(364:454)],authors2)
length(AuthorList) #double check that everything added together correctly 

FirstAuthors <- c(firstauth[-c(364:454)],firstauth2)

CoAuthors <- c(coauth[-c(364:454)],coauth2)
```

So now that we have our (basically) complete lists, we need to deal with the leading whitespaces and the different ways the USA is written  
```{r}
AuthorList <- lapply(authors2,function(x) {trimws(x,which="left")}) 
FirstAuthors <- lapply(firstauth,function(x) {trimws(x,which="left")}) 
CoAuthors <- lapply(coauth,function(x) {trimws(x,which="left")}) 

head(AuthorList)
head(FirstAuthors)
head(CoAuthors)
```

```{r}
AuthorListrep <- rapply(AuthorList, function(x) ifelse(grepl("US|States",x),"United States of America",x), how = "replace")
FirstAuthorsrep <- rapply(FirstAuthors, function(x) ifelse(grepl("US|States",x),"United States of America",x), how = "replace")
CoAuthorsrep <- rapply(CoAuthors, function(x) ifelse(grepl("US|States",x),"United States of America",x), how = "replace")
```

```{r}
#can check that the replacement worked  
#AuthorList
#AuthorListrep

#only issue I think is #406
#[[406]]
#[1] "FL 33149" "TX 77843"

#check we'd only be replacing those values  
grepl("FL|TX",AuthorListrep) %>% summary() 
# TRUE=1
grepl("FL|TX",FirstAuthorsrep) %>% summary() 
grepl("FL|TX",CoAuthorsrep) %>% summary() 

AuthorListreps <- rapply(AuthorListrep, function(x) ifelse(grepl("FL|TX",x),"United States of America",x), how = "replace")
FirstAuthorsreps <- rapply(FirstAuthorsrep, function(x) ifelse(grepl("FL|TX",x),"United States of America",x), how = "replace")
CoAuthorsreps <- rapply(CoAuthorsrep, function(x) ifelse(grepl("FL|TX",x),"United States of America",x), how = "replace")
#AuthorListreps
```


# Address NA countries?   
Ask why in meeting 
```{r}
firstauth[is.na(firstauth)] 
```

# Convert to df  
```{r}
AuthorListeven<-lapply(AuthorListreps, "length<-" , max(lengths(AuthorListreps)))
#head(AuthorListeven)

AuthorList.df <- as.data.frame(do.call(rbind,AuthorListeven)) 
#head(AuthorList.df)
```

```{r}
FirstAuthorseven<-lapply(FirstAuthorsreps, "length<-" , max(lengths(FirstAuthorsreps)))
#head(FirstAuthorseven)

FirstAuthors.df <- as.data.frame(do.call(rbind,FirstAuthorseven)) 
#head(FirstAuthors.df)
```

```{r}
CoAuthorseven<-lapply(CoAuthorsreps, "length<-" , max(lengths(CoAuthorsreps)))
#head(CoAuthorseven)

CoAuthors.df <- as.data.frame(do.call(rbind,CoAuthorseven)) 
#head(CoAuthors.df)
```


# export final lists  
```{r}
write_csv(AuthorList.df,"MAR_litreview_authorcountries.csv")
write_csv(FirstAuthors.df,"MAR_litreview_firstauthorcountries.csv")
write_csv(CoAuthors.df,"MAR_litreview_coauthorcountries.csv")
```


# Using whole spreadsheet to look at patterns in related variables  

## duplicate addresses  
Trying to duplicate addresses for authors who were lumped together in square brackets because they're from the same institution 
Come  back to this  
```{r,eval=FALSE}
#strsplit(countries$addresses,"\\[[^\\]]*\\](*SKIP)(*F)|\\h*;\\h*", perl=T)
countries %>% 
  filter(str_detect(addresses,"]") ) %>% 
  mutate(n=str_count(
    addresses, 
    str_match(string=";",
              pattern="\\[(;)\\]"
              )
    ), 
    .after=authors)



str_match_all(string=countries$addresses,pattern=";") %>% head()

countries %>% 
  filter(str_detect(addresses,"]") ) %>% .$addresses %>% str_extract_all(.,"\\[(.*?)\\]") %>% map_chr(.,toString) %>% head()
```
```{r,eval=FALSE}
countries %>% select(c(authors,addresses)) %>% mutate(newauth=str_count(authors,pattern=";"),
                      newadd=str_count(addresses,pattern=";"),
                      same=(newauth==newadd)) %>% filter(same==FALSE) 
```

### Replace spaces in country names    
```{r}
rep.countries <- newcountries 
rep.countries$addresses <- str_replace_all(rep.countries$addresses, "USA|US|U.S.A.|United States|United States of America", " USA")  
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "Britain|Great Britain", "Great_Britain") 
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "United Kingdom|UK", "United_Kingdom") 
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "New Caledonia", "New_Caledonia") 
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "Hong Kong", "Hong_Kong") 
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "Costa Rica", "Costa_Rica") 
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "South Africa", "South_Africa") 
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "United Arab Emirates", "UAE") 
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "South Korea", "South_Korea") 
rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "Puerto Rico", "Puerto_Rico")
rep.countries$addresses <- str_replace_all(rep.countries$addresses,"Cayman Islands", "Cayman_Islands")
rep.countries$addresses <- str_replace_all(rep.countries$addresses,"Trinidad and Tobago", "Trinidad_and_Tobago")
rep.countries$addresses <- str_replace_all(rep.countries$addresses,"Virgin Islands (British)|Virgin Islands", "Virgin_Islands")
rep.countries$addresses <- str_replace_all(rep.countries$addresses,"St Kitts & Nevi", "StKitts_and_Nevi")
#rep.countries$addresses <-   str_replace_all(rep.countries$addresses, "FL|TX|ILLINOIS", "USA")

#rep.countries$addresses <- lapply(rep.countries$addresses, function(x) sub("\\Florida.*","USA",x))
#rep.countries$addresses <- lapply(rep.countries$addresses, function(x) sub("\\Texas.*","USA",x))
#rep.countries$addresses <- lapply(rep.countries$addresses, function(x) sub("\\FL.*","USA",x))
#rep.countries$addresses <- lapply(rep.countries$addresses, function(x) sub("\\TX.*","USA",x))
#rep.countries$addresses <- lapply(rep.countries$addresses, function(x) sub("\\New York.*","USA",x))
#rep.countries$addresses <- lapply(rep.countries$addresses, function(x) sub("\\ILLINOIS.*","USA",x))

#tmp <- rep.countries %>%
# mutate(
#    countries_test = (strsplit(addresses,"\\[[^\\]]*\\](*SKIP)(*F)|\\h*;\\h*", perl=T) #%>% 
#                            #lapply(.,function(x) {word(x,start=-1,sep=" ")}) %>% 
#                            #map_chr(.,toString) 
#                          ),
#         countries_all = (strsplit(addresses,"\\[[^\\]]*\\](*SKIP)(*F)|\\h*;\\h*", perl=T) %>% 
#                            lapply(.,function(x) {word(x,start=-1,sep=" ")}) %>% 
#                            map_chr(.,toString) 
#                          ),
#         first_authors = (word(countries_all,start=1,sep=",")),
#         #coauthors = countries_all[[-1]],
#         .after=addresses) 

author.countries.df <- rep.countries %>% 
  mutate(addresses=sub("\\Florida.*"," USA",addresses)) %>% 
  mutate(addresses=sub("\\Texas.*"," USA",addresses)) %>% 
  mutate(addresses=sub("\\FL.*"," USA",addresses)) %>% 
  mutate(addresses=sub("\\TX.*"," USA",addresses)) %>% 
  mutate(addresses=sub("\\New York.*"," USA",addresses)) %>% 
  mutate(addresses=sub("\\ILLINOIS.*"," USA",addresses)) %>% 
  mutate(countries_all = (strsplit(addresses,"\\[[^\\]]*\\](*SKIP)(*F)|\\h*;\\h*", perl=T) %>% 
                            lapply(.,function(x) {word(x,start=-1,sep=" ")}) %>% 
                            map_chr(.,toString) 
                          ),
                          .after=addresses) %>% 
  separate(countries_all,into=c("first_authors","coauthors"),sep=",",extra="merge",remove=F)
```

```{r}
library(ggplot2)
library(ggridges)
```

## Make figure data frames  
```{r}
firstauthcountries.df <- author.countries.df %>% 
  add_count(first_authors,sort=TRUE) %>% #filter(n>1) %>%
  mutate(first_authors=factor(first_authors,
                              levels=unique(first_authors),ordered=TRUE)) %>% 
  ungroup() %>% group_by(year) %>% mutate(papers_peryear=n()) %>% 
  group_by(year,first_authors,papers_peryear) %>% reframe(author_peryear=n(),n=n) 
```

```{r}
# unique countries publishing in the MAR 
all.countries <- lapply((author.countries.df %>% 
  separate_wider_delim(.,cols=countries_all,delim=",",names_sep="_",too_few="align_start") %>% select(starts_with("countries"))),unique) %>% c() %>% unlist() %>% trimws(.,which="left") %>% unique()
```

```{r}
year.countries.df <-  author.countries.df %>% 
  separate_wider_delim(.,cols=countries_all, #separate the list of all author countries 
                       delim=",", #separate by comma
                       names_sep="_", #delimiter separating names of new columns
                       too_few="align_start") %>% #if there are uneven numbers, fill the remaining with NA  
  select(c(year,starts_with("Type"),language,starts_with("countr"))) %>% #keep only year, type of paper, language, and country columns  
  #group_by(year) %>% summarize(across(starts_with("count"),n_distinct))
pivot_longer(cols=c(starts_with("countries")), #take all country columns and make each their own row. makes a new column 'name' with the column name each country value came from 
              #names_to="year",
              values_drop_na=TRUE
              ) %>% 
  mutate(value=trimws(value,which="left")) %>%
  group_by(year,value,name) %>% 
  mutate(firstauth=case_when(name=="countries_all_1" ~ n(), #get the count of number of first author papers for each country each year
                             .default=NA)) %>%
  ungroup() %>%
  group_by(year,value) %>% 
  reframe(countries_peryear = n(), #get the count of number of times an author from each country is published each year
            firstauth=unique(firstauth)) %>% 
  group_by(year,value) %>% 
  filter(n()>1 & !is.na(firstauth) | n()==1) %>% #filter out duplicate rows where a country has a first author 
  ungroup() %>% 
  group_by(value) %>% 
  mutate(total_percountry = sum(countries_peryear,na.rm=TRUE), #get the total number of times a country is in a published paper  
         total_firstauth = sum(firstauth,na.rm=TRUE)) %>% #get the total number of first author papers for each paper  
  ungroup() %>%
  add_count(value,sort=TRUE) %>% 
  mutate(value=factor(value,levels=rev(unique(value)),ordered=TRUE)) #order in descending order by the total number of papers
```

```{r}
 year.countries.df <- author.countries.df %>% 
  separate_wider_delim(.,cols=countries_all, #separate the list of all author countries 
                       delim=",", #separate by comma
                       names_sep="_", #delimiter separating names of new columns
                       too_few="align_start") %>% #if there are uneven numbers, fill the remaining with NA  
  select(c(year,starts_with("Type"),language,starts_with("countr"))) %>% #keep only year, type of paper, language, and country columns  
  #group_by(year) %>% summarize(across(starts_with("count"),n_distinct))
pivot_longer(cols=c(starts_with("countries")), #take all country columns and make each their own row. makes a new column 'name' with the column name each country value came from 
              #names_to="year",
              values_drop_na=TRUE
              ) %>% 
  mutate(value=trimws(value,which="left"),
          type=case_when(`Type of Paper` == "Basic/descriptive science" ~ "A", 
                         `Type of Paper` == "Perspective/opinion" ~ "B", 
                         `Type of Paper` == "Applied science" ~ "C", 
                         .default=NA)) %>%
  group_by(year,value,name) %>% 
  mutate(firstauth=case_when(name=="countries_all_1" & row_number() == 1 ~ n(), #get the count of number of first author papers for each country each year
                             .default=NA)) %>%
  ungroup() %>%
  group_by(year,value) %>% 
  mutate(countries_peryear = case_when(
    row_number() == 1 ~ n(),
    .default=NA
  )) %>% distinct() %>%
  #group_by(year,value) %>% 
  #filter(n()>1 & !is.na(firstauth) | n()==1) %>% #filter out duplicate rows where a country has a first author 
  ungroup() %>% 
  group_by(value) %>% 
  mutate(total_percountry = case_when( row_number() == 1 ~ sum(countries_peryear,na.rm=TRUE),
    .default=NA ), #get the total number of times a country is in a published paper  
         total_firstauth = case_when(row_number() == 1 ~ sum(firstauth,na.rm=TRUE),
    .default=NA )
    ) %>% #get the total number of first author papers for each paper  
  ungroup() %>%
  arrange(desc(total_percountry)) %>% 
  mutate(value=factor(value,levels=rev(unique(value)),ordered=TRUE)) #order in descending order by the total number of papers
```
```{r}
author.countries.plotting.df <- author.countries.df %>% select(-c("authors","addresses")) %>%
  mutate(type=case_when(`Type of Paper` == "Basic/descriptive science" ~ "A", 
                         `Type of Paper` == "Perspective/opinion" ~ "B", 
                         `Type of Paper` == "Applied science" ~ "C", 
                         .default=NA),
         OA=case_when(str_detect(open_access,"old") ~ "Gold",
                      str_detect(open_access,"ronze") ~ "Bronze",
                      str_detect(open_access,"reen") ~ "Green",
                      str_detect(open_access,"iamond|latinum") ~ "Diamond",
                      str_detect(open_access,"ybrid") ~ "Hybrid",
                      .default=NA
                      ),
         marfirst=case_when(str_detect(first_authors,"Mexico|Belize|Guatemala|Honduras") ~ "Lead",
                            str_detect(coauthors,"Mexico|Belize|Guatemala|Honduras") ~ "Coauthor", .default=NA),.after="first_authors") 
```

# Plots  
```{r}
paper.marauth <- ggplot(author.countries.plotting.df) + geom_bar(aes(x=year,fill=marfirst),color="black") + scale_fill_manual(name="In collaboration \n with someone in country",values=c("#2a9d8f","#e76f51"),na.value = "grey60")

paper.lang <- ggplot(author.countries.plotting.df) + geom_bar(aes(x=year,fill=language),color="black") + scale_fill_manual(name="Published language",values=c("#89a1ef","#5c8001"),na.value = "grey60")

paper.type <- ggplot(author.countries.plotting.df) + geom_bar(aes(x=year,fill=`Type of Paper`),color="black") + scale_fill_manual(name="Type of research",values=c("#8338ec","#e07a5f","#3d405b"),na.value = "grey60") + guides(fill=guide_legend(nrow=2))

paper.oa <- ggplot(author.countries.plotting.df) + geom_bar(aes(x=year,fill=OA),color="black") + scale_fill_manual(name="Open access status",values=c("#a3a380","#e09f3e","#335c67","#9e2a2b"),na.value = "grey60") + guides(fill=guide_legend(nrow=2))

wrap_plots(paper.marauth,
           paper.lang,
           paper.type,
           paper.oa) + 
  plot_annotation(tag_levels="A",tag_suffix = ".")  & theme_bw()  + 
  ggpubr::labs_pubr()  + 
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="bottom",
        panel.grid.major.y = element_line(color="grey80"),
        line = element_line(linewidth=0.5)
        )

#ggsave("/Users/lauragivens/Downloads/mismatchvars.png",height=10,width=12)
```

Number of papers published from a country over time   
```{r}
country.authors.dotplot <-  year.countries.df %>% group_by(year,value) %>% summarize(firstauth=sum(firstauth,na.rm=TRUE),countries_peryear=sum(countries_peryear,na.rm=TRUE)) %>% #year.countries.df %>% 
  ggplot(aes(x=year,y=value,color=firstauth)) + 
  geom_point(aes(size=countries_peryear),alpha=0.95) + 
  scale_size_continuous(name="Number of \n authors",range=c(3,10),breaks=c(1,5,10,20,40,55)) +
  scale_color_gradientn(name="Number of \n first author \n publications",
                        colors=c("#d2ebf1","#219ebc","#176e83","#023047","#ffb703","#fb9d32","#fb8500")) + 
  scale_x_continuous(minor_breaks = seq(from=1960,to=2025,by=5)) +
  theme_bw() + 
  ggpubr::labs_pubr() +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="bottom",
        panel.grid.major.y = element_line(color="grey80")
        #panel.grid.minor.x = element_line(linetype=2,color="grey")
        ) + 
  guides(size=guide_legend(nrow=1,theme=theme(legend.key.size = unit(3, "point")))) +
  labs(title="Authors in papers published each year",
       caption="Points without a first author publication are colored in grey")

country.authors.dotplot

#ggsave("/Users/lauragivens/Downloads/roughdraft2.png",country.authors.dotplot,width=20,height=15)
```
```{r}
country.pal <- c("#2f4b7c",
"#a05195","#665191","#d45087",
"#f95d6a","#ff7c43","#ffa600",
"#003f5c","#4553c2", "#80b6aa", "#255026", "#49c32f", "#8e0049", "#fd5917", "#14c197", "#265582", "#d98ff4", "#7b038e", "#f75ef0", "#87a9fd", "#2524f9", "#85aa32", "#633d30", "#f5943b", "#a51409", "#fd8992", "#ff0087", "#c6a2ac",
"#78b4c6", "#016876", "#5faf66", "#1f3ca6", "#e689eb", "#841ea4", "#9a95e5", "#5b3c5e", "#f642d0", "#0b5313", "#f85582", "#943105", "#f9905b", "#972554", "#0ec61c", "#e8250c", "#55450a", "#cba662", "#270fe2","#e29578","#83c5be","#ffddd2","#9c89b8","#ffbe0b"
  )

scales::show_col(country.pal)

names(country.pal) <- unique(year.countries.df$value)
```

```{r}
year.country.ridgeplot <- ggplot(year.countries.df, aes(x=year,y=value,height=countries_peryear,fill=value)) + 
  geom_density_ridges2(scale = 8,linewidth=.1,alpha=0.9,stat="identity",na.rm=TRUE) +
  #theme_ridges()  + 
  theme_bw() +
  scale_fill_manual(values=country.pal) + 
  ggpubr::labs_pubr() +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="none",
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) + 
  labs(title="Change in authored papers by year") 

year.country.ridgeplot

#ggsave("/Users/lauragivens/Downloads/roughdraft1.png",year.country.ridgeplot,width=15,height=10)
```

```{r}
year.country.ridgeplot2 <- year.country.ridgeplot +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0)) 

country.authors.dotplot2 <- country.authors.dotplot +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0))
```

```{r}
patchwork::wrap_plots((country.authors.dotplot2+theme(legend.position="top")+labs(caption=NULL)), #dotplot: country vs year, size of dot = number of papers that year, color=number of first authors
           free(year.country.ridgeplot2) #ridgeplot: country vs year
           )  +
  plot_layout(widths=c(10,8))  + 
  plot_annotation(title="Availability of evidence to inform marine conservation management in the Mesoamerican Reef Ecoregion",
                  tag_levels="A",tag_suffix=".") & theme(text=element_text(size=16),plot.title=element_blank())

#ggsave("/Users/lauragivens/Downloads/pubovertime.png",width=20,height=12)
```

# Subset countries  
Number of papers published from a country over time   
```{r}
top10 <- year.countries.df %>% arrange(desc(total_percountry)) %>% .$value %>% unique() %>% .[1:10]

top15 <- year.countries.df %>% filter(value != "NA") %>% arrange(desc(total_percountry)) %>% .$value %>% unique() %>% .[1:15]
```
```{r}
subs.country.authors.dotplot <- year.countries.df %>% group_by(year,value) %>% summarize(firstauth=sum(firstauth,na.rm=TRUE),countries_peryear=sum(countries_peryear,na.rm=TRUE)) %>% filter(value%in%top15) %>% filter(!is.na(firstauth) | !is.na(countries_peryear)) %>%
  ggplot(aes(x=year,y=value,
             color=ifelse(!is.na(firstauth),firstauth,NA))) + 
  geom_point(aes(size=ifelse(!is.na(countries_peryear),countries_peryear,NA)),alpha=0.95) + 
  scale_size_continuous(name="Number of \n authors",range=c(3,10),breaks=c(1,5,10,20,40,55)) +
  scale_color_gradientn(name="Number of \n first author \n publications",
                        colors=c("grey","#219ebc","#176e83","#023047","#ffb703","#fb9d32","#fb8500")) + 
  scale_x_continuous(minor_breaks = seq(from=1960,to=2025,by=5)) +
  theme_bw() +
  ggpubr::labs_pubr() +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0)) + 
  theme(legend.position="top")+labs(caption=NULL)  +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        panel.grid.major.y = element_line(color="grey80")
        #panel.grid.minor.x = element_line(linetype=2,color="grey")
        ) + 
  guides(size=guide_legend(nrow=1,theme=theme(legend.key.size = unit(3, "point")))) +
  labs(title="Authors in papers published each year",
       caption="Points without a first author publication are colored in grey")

subs.year.country.ridgeplot <- year.countries.df %>% filter(value%in%top15) %>% 
  ggplot( aes(x=year,y=value,height=countries_peryear,fill=value)) + 
  geom_density_ridges2(scale = 8,linewidth=.1,alpha=0.9,stat="identity",na.rm=TRUE) +
  #theme_ridges()  + 
  theme_bw() +
  scale_fill_manual(values=country.pal) + 
  ggpubr::labs_pubr()  +
  scale_x_continuous(limits=c(1990,2026), expand = c(0,0)) +
  #cowplot::theme_minimal_hgrid() +
  theme(text=element_text(size=20),
        axis.title=element_blank(),
        legend.position="none",
        panel.grid.major.y = element_line(color="grey80"),
        panel.grid.minor.x = element_line(linetype=2,color="lightgrey",linewidth = 0.25)
        ) + 
  labs(title="Change in authored papers by year") 

patchwork::wrap_plots(subs.country.authors.dotplot, 
           subs.year.country.ridgeplot #free(subs.year.country.ridgeplot)
           )  +
  plot_layout(widths=c(10,8),design="
              #B
              AB
              AB")  + 
  plot_annotation(title="Availability of evidence to inform marine conservation management in the Mesoamerican Reef Ecoregion",
                  tag_levels="A",tag_suffix=".") & theme(text=element_text(size=16),plot.title=element_blank())

#ggsave("/Users/lauragivens/Downloads/pubovertime.subset.png",width=8,height=5)
```

```{r}
subs.country.authors.dotplot + theme(plot.title=element_blank(), plot.caption = element_blank())

 ggsave("/Users/lauragivens/Downloads/top15.country.authors.dotplot.png",width=10,height=10)
```

```{r}
subs.year.country.ridgeplot + theme(plot.title=element_blank(), plot.caption = element_blank())

# ggsave("/Users/lauragivens/Downloads/top15.country.year.dotplot.png",width=8,height=12)
# ggsave("/Users/lauragivens/Downloads/top15.country.year.dotplot.png",width=15,height=12)
```

# Analysis  
```{r}
year.countries.df$value %>% unique() %>% length()
```

```{r}
year.countries.df %>% filter(firstauth>0 & !is.na(firstauth)) %>% .$value %>% unique() %>% length()
```

Do those super productive countries change if we only look at the last 10 years? How about 5? 
```{r}
top10.2015 <- year.countries.df %>% filter(year>2015) %>% group_by(value) %>% mutate(newtotal=sum(countries_peryear,na.rm = TRUE)) %>% arrange(desc(newtotal)) %>% .$value %>% unique() %>% .[1:10]

top10.2020 <- year.countries.df %>% filter(year>2020) %>% group_by(value) %>% mutate(newtotal=sum(countries_peryear,na.rm = TRUE)) %>% arrange(desc(newtotal)) %>% .$value %>% unique() %>% .[1:10]

top10.2015
top10.2020
```
```{r}
top10
```
```{r}
year.countries.df %>% group_by(year) %>%
  reframe(rlow=range(countries_peryear,na.rm=TRUE)[1],
          rhigh=range(countries_peryear,na.rm=TRUE)[2]) %>% ggplot(aes(x=year)) + geom_line(aes(y=rlow)) + geom_line(aes(y=rhigh),color="blue")
```


#### Participation in research  
```{r}
participation.df <- author.countries.plotting.df %>% 
  group_by(year,marfirst) %>% summarize(n=n()) %>% 
  pivot_wider(names_from="marfirst",values_from="n") %>% 
  mutate(total=sum(`NA`,Lead,Coauthor,na.rm=TRUE),
         perc=sum(Lead,Coauthor,na.rm = TRUE)/total
         ) %>% arrange(desc(year))

participation.df
```
```{r}
participation.df %>% filter(year>2019 & year <2025) %>% .$perc %>% range(.,na.rm=TRUE)
participation.df %>% filter(year>2019 & year <2025) %>% .$perc %>% mean(.,na.rm=TRUE)
```

```{r}
participation.df %>% filter(year<2020 & year>1999 & total>1) %>% .$perc %>% range(.,na.rm=TRUE)
participation.df %>% filter(year<2020 & year>1999 & total>1) %>% .$perc %>% mean(.,na.rm=TRUE)
```

```{r}
participation.df %>% filter(year<2000 & total>1) %>% .$perc %>% range(.,na.rm=TRUE)
participation.df %>% filter(year<2000 & total>1) %>% .$perc %>% mean(.,na.rm=TRUE)
```

#### Type of research  
```{r}
author.countries.plotting.df %>% group_by(year,`Type of Paper`) %>% 
  summarize(n=n()) %>% 
  pivot_wider(names_from=`Type of Paper`,values_from="n") %>% 
  mutate(total=sum(`NA`,"Basic/descriptive science","Perspective/opinion","Applied science",na.rm=TRUE),
         perc=sum("Applied science",na.rm = TRUE)/total
         ) %>% arrange(desc(year))
```


# Maps  
```{r,warning=FALSE}
globe <- map_data("world")
globe.mar <- full_join(globe,(year.countries.df %>% group_by(value) %>% mutate(firstauth=sum(firstauth,na.rm=TRUE),
                                                                               ) %>% mutate(region=str_replace_all(value,"_"," "))))

cons <- country_codes()
```
All countries 
```{r}
ggplot() + geom_polygon(data=globe.mar,aes(x=long,y=lat,group=group,fill=!is.na(value)),color="black") + scale_fill_manual(name="Countries publishing MAR research",values=c("lightgrey","#2a9d8f")) + 
  ggpubr::theme_pubclean() +
  theme(axis.title=element_blank(),axis.text=element_blank(),axis.ticks = element_blank(),legend.position="none") 

#ggsave("/Users/lauragivens/Downloads/mar.map.png",width=8,height=5)
```

First author countries  
```{r}
ggplot() + 
  geom_polygon(data=globe.mar,
               aes(x=long,y=lat,
                   group=group,
                   fill=ifelse(total_firstauth>0,!is.na(total_firstauth),NA)),color="black") + 
  scale_fill_manual(name="Countries publishing MAR research",
                    values=c("#f4a261"),
                    na.value = "lightgrey") + 
  ggpubr::theme_pubclean() +
  theme(axis.title=element_blank(),axis.text=element_blank(),axis.ticks = element_blank(),legend.position="none") 

ggsave("/Users/lauragivens/Downloads/mar.firstauth.map.png",width=8,height=5)
```

```{r}
ggplot(data=globe.mar) +
  geom_polygon(aes(x=long,y=lat,group=group,fill=total_percountry),color="black") + 
  geom_point(aes(x=long,y=lat,
                 color=total_firstauth,group=group,
                 size=ifelse(total_firstauth>0 & !duplicated(value),total_firstauth,NA))) + 
  scale_size(name="First author pubs",
             breaks=c(1,10,20,30,60,90,120,150),
             range=c(4,12)) + 
  scale_fill_viridis_b(name="Total publications",
                       option="F",
                       begin=0.2,end=0.9,
                       na.value="lightgrey",
                       breaks=c(1,10,20,30,60,90,120,150)) + 
  scale_color_gradientn(name="First author pubs",
                        na.value = "lightgrey",colors=rev(c("#264653","#2a9d8f","#e9c46a","#f4a261")),
  #scale_color_gradientn(na.value = "lightgrey",colors=c("#8ecae6","#219ebc","#023047","#ffb703","#fb8500"),
                       breaks=waiver(),n.breaks=10 ) + 
  theme_bw() + theme(legend.position="top")
```

# other figs  
```{r}
firstauthcountries.df %>% ggplot(aes(x=year,fill=first_authors)) + geom_bar()
firstauthcountries.df %>% ggplot(aes(x=year,y=papers_peryear,fill=first_authors)) + geom_bar(stat="identity",position="dodge")
```

```{r}
firstauthcountries.df %>% filter(n>2) %>% ggplot(aes(x=year,y=first_authors,fill=first_authors)) + 
  geom_density_ridges2(scale = 5,linewidth=1.3,alpha=0.9) +
  theme_ridges() + theme(legend.position="none")

#ggsave("/Users/lauragivens/Downloads/roughdraft.png",width=15,height=7)
```
```{r}
firstauthcountries.df %>% filter(n>2) %>% ggplot(aes(x=year,y=first_authors,fill=first_authors)) + 
  geom_density_ridges2(scale = 5,linewidth=1.3,alpha=0.9) +
  theme_ridges() + theme(legend.position="none")
```

```{r,warning=FALSE}
year.countries.df %>% 
ggplot() + 
  geom_point(aes(x=ifelse(total_percountry>0 & !duplicated(value),total_percountry,NA),y=value),alpha=0.7) + 
  geom_point(aes(x=ifelse(total_firstauth>0 & !duplicated(value),total_firstauth,NA),y=value),alpha=0.9,color="red") +
  theme_bw() + 
  ggpubr::labs_pubr() +
  theme(text=element_text(size=20),
        axis.title.y=element_blank(),
        panel.grid.major.y = element_line(color="grey80")
        #panel.grid.minor.x = element_line(linetype=2,color="grey")
        ) + 
  guides(size=guide_legend(nrow=1)) +
  labs(title="Country affiliation of authors of papers published ",
       caption="First author country affiliation colored in red",
       x="Number of authors")

#ggsave("/Users/lauragivens/Downloads/roughdraft4.png",width=10,height=15)
```
```{r}
scales::show_col(viridis::viridis_pal(option="D",begin=0,end=1)(5))
scales::show_col(viridis::viridis_pal(option="C",begin=0,end=1)(5))
scales::show_col(viridis::viridis_pal(option="B",begin=0.1,end=0.9)(5))
scales::show_col(viridis::viridis_pal(option="A",begin=0.2,end=0.9)(5))

country.pal2 <- c(
                  viridis::viridis_pal(option="D",begin=0,end=1)(5),
                  "#2f4b7c","#a05195","#665191","#d45087","#f95d6a",
                  rev(viridis::viridis_pal(option="C",begin=0,end=1)(5)),
                  "#ff7c43","#ffa600",
                  viridis::viridis_pal(option="B",begin=0.1,end=0.8)(5),
                  viridis::viridis_pal(option="A",begin=0.2,end=0.9)(5)
                  )

scales::show_col(country.pal2)
```

```{r}
firstauthcountries.df %>% filter(n>2) %>% ggplot(aes(x=year,y=first_authors,fill=first_authors)) + 
  geom_density_ridges2(scale = 5,linewidth=1.3,alpha=0.9) +
  theme_ridges() + theme(legend.position="none")

year.countries.df %>% ggplot(aes(x=year,y=value,height=countries_peryear,fill=value)) + 
  #geom_density_ridges2(scale = 5,linewidth=1.3,alpha=0.9) +
  geom_ridgeline(scale=1,linewidth=1,alpha=0.6) +
  theme_ridges() + theme(legend.position="none")
```


```{r}
save.image("~/Documents/GitHubRepos/MARLitReview/.RData")
sessionInfo()
```

